---
title: ""
output: html_notebook
---

#### Практическая работа №5
### 6. Непараметрические коэффициенты корреляции. Значимость частных коэффициентов регрессии
### 7. Факторный анализ

> Глушков Егор Александрович, гр. 20.М04-мм  
> Вариант 4

---

> 6. Непараметрические коэффициенты корреляции. Значимость частных коэффициентов регрессии

Данные addicts.xls. Переменные (вариант 4):

+ $X_1$  -- *sstati* -- оценка уровня тревожности
+ $X_2$ -- *asi1_med* -- индекс зависимости тяжести медицинского статуса
+ $X_3$ -- *asi2_emp* -- индекс зависимости тяжести социального статуса (занятость, заработок)
+ $X_4$ -- *asid3_dyr* -- длительность героиновой зависимости  
+ $Y$ -- *asi7_psy* -- индекс зависимости тяжести психиатрического статуса  


1. Построить корреляционную матрицу по метрическим переменным $X_1, ... , X_4$ и выделить наиболее значимую корреляцию. Для этого случая построить двумерную диаграмму.

2. Применить модель множественной регресссии для зависимой переменной $Y$ и для независимых переменных $X_1, ... , X_4$. Определить значимость прогноза и указать наиболее значимые переменные.

3. Вычислить частный коэффициент корреляции $\rho_{YX_1 \cdot X_2 X_3 X_4}$.

---

> Корреляционная матрица, значимые корреляции

```{r}
library(readxl)
addicts <- read_excel("addicts.xlsx")
# View(addicts)
```

Исследуем переменные на наличие пропусков. Выделим нужные переменные 
```{r}
data <- na.omit(addicts[ , c("sstati", "asi1_med", "asi2_emp", "asid3_dyr", "asi7_psy")])
summary(data)
```
Проверяем данные на нормальность
```{r}
lshap <- lapply(data, shapiro.test)
lres <- sapply(lshap, `[`, c("statistic","p.value")); lres
```
Лишь p.value, соответствующий переменной *sstati*, больше уровня значимости 0.05, что говорит о том, что распределение этих данных незначимо отличается от нормального. Другими словами, можно предположить их нормальность. Для других переменных гипотеза о нормальности отвергается, вследствие чего следует предпочесть непараметрические коэффициенты корреляции (Спирмена, Кендалла), чем более привычный коэффициент корреляции Пирсона.

```{r}
cor(data, method="pearson")
ms <- cor(data, method="spearman"); ms
cor(data, method="kendall")
```


```{r}
show_cor_test <- function(x1, x2) {
  sp <- cor.test(x1, x2, method="spearman", exact=FALSE)
  k <- cor.test(x1, x2, method="kendall", exact=FALSE)
  df <- data.frame(cbind(c(sp$estimate, sp$p.value), c(k$estimate, k$p.value)), 
                   row.names=c("corr coeff (rho | tau resp)", "p.value"))
  colnames(df)<-c('spearman', 'kendall')
  df
}
```


Выделим наиболее значимые корреляции: уровень тревожности и психиатрический статус
```{r}
show_cor_test(data$sstati, data$asi7_psy)
```
Как видно, $\rho$ и $\tau$ не так высоки (0.216 и 0.15), однако с учетом соответствующих *p.value* можно принять гипотезы о том, что данные коэффициенты корреляции Спирмена и Кендалла ненулевые.  
  
Аналогично с уровнем тревожности и медицинским статусом
```{r}
show_cor_test(data$sstati, data$asi1_med)
```
Коэффициенты корреляции не высоки, однако p.value говорят о том, что коэффициенты не равны нулю

Такая же ситуация с психиатрическим и социальным статусами 
```{r}
show_cor_test(data$asi7_psy, data$asi2_emp)
```

Построим heatmap с соответствующими коэффициентами корреляции Спирмена:
```{r}
library(GGally)
ggcorr(data, method=c("pairwise", "spearman"), label=TRUE)
```

Двумерная диаграмма для уровня тревожности и психиатрического статуса:
```{r message=FALSE, warning=FALSE}
str <- paste("r", round(cor(data$sstati, data$asi7_psy, method='spearman'), 3), sep="=")
qplot(sstati, asi7_psy, data = data, geom = c("point", "smooth"), method = "lm") + labs(title=str) + theme(plot.title = element_text(hjust = 0.5))
```

Двумерная диаграмма для уровня тревожности и медицинского статуса:
```{r message=FALSE, warning=FALSE}
str <- paste("r", round(cor(data$sstati, data$asi1_med, method='spearman'), 3), sep="=")
qplot(sstati, asi1_med, data = data, geom = c("point", "smooth"), method = "lm") + labs(title=str) + theme(plot.title = element_text(hjust = 0.5))
```

Двумерная диаграмма для социального и психиатрического статусов:
```{r message=FALSE, warning=FALSE}
str <- paste("r", round(cor(data$asi2_emp, data$asi7_psy, method='spearman'), 3), sep="=")
qplot(asi2_emp, asi7_psy, data = data, geom = c("point", "smooth"), method = "lm") + labs(title=str) + theme(plot.title = element_text(hjust = 0.5))
```
Можно заметить, что имеющаяся линейная связь между этими парами переменных весьма слабая (тем не менее, значима)

> Модель множественной регресссии

Применим модель множественной регрессии с asi7_psy как зависимой переменной
```{r}
mreg <- lm(asi7_psy ~ sstati + asi1_med + asi2_emp + asid3_dyr, data=data)
summary(mreg)
```
Согласно $p.value < 0.05$ (а именно согласно значимости прогноза *2.689e-05 < 0.05*) отвергается гипотеза о том, что данная модель не зависит от предикторов. Значимыми (ненулевыми) коэффициентами с уровнем 0.05 являются значения при переменных *sstati* и *asi2_emp*, чего и следовало ожидать из проведенного выше корреляционного анализа (именно коэффициенты корреляции этих пар переменных были наибольними).


Проверим некоррелированность остатков [практически равны 0]
```{r}
c(cor(mreg$residuals, data$sstati), cor(mreg$residuals, data$asi1_med ), cor(mreg$residuals, data$asi2_emp ), cor(mreg$residuals, data$asid3_dyr))
```

> Частный коэффициент корреляции $\rho_{YX_1 \cdot X_2 X_3 X_4}$

```{r}
library(matlib)
ms
```
$$ \rho_{YX_1 \cdot X_2 X_3 X_4} = - \frac{\Lambda_{Y X_1}}{\sqrt{\Lambda_{Y Y} \Lambda_{1 1}}}$$ 
где $\Lambda_{ij}$ -- алгебраическое дополнение элемента $\lambda_{ij}$ корреляционной матрицы $\Lambda$

```{r}
rho <- - cofactor(ms, 5, 1) / sqrt(cofactor(ms, 5, 5) * cofactor(ms, 1, 1))
c(r.yx1=ms[1, 5], rho=rho)
```

$r_{Y X_1} > \rho_{YX_1 \cdot X_2 X_3 X_4}$, то факторы $X_2, X_3, X4$ [немного] искажают взаимосвязь между $Y$ и $X_1$ в сторону её увеличения

---

> 7. Факторный анализ

Задание.  
Построить матрицу факторных нагрузок. Проинтерпретировать главные компоненты, определить вклад первых двух в общую дисперсию и построить двумерную диаграмму первых двух факторов.

---

Вклад главных компонент в общую дисперсию
```{r}
pc <- princomp(scale(data))
summary(pc)
```
Первые две компоненты дают `r 0.5204587 * 100`%


Факторные нагрузки
```{r}
pc$loadings[, seq(5)]
```
Первая компонента отвечает за "медицинские" факторы: тревожность, медицинский и психиатрический статус, длительность героиновой зависимости, притом везде связь прямо пропорциональна.  
Вторая компонента связана с понижением социального статуса и повышением медицинского статуса.  
Третья -- с понижением длительности героиновой зависимости.  
Четвертая -- с понижением медицинского статуса и повышением уровня тревожности.  
Пятая компонента говорит о повышении уровня тревожности и социального статуса вместе с понижением психиатрического статуса.  

Проверка [совпадают с точностью до перестановки знаков для, например, первого фактора]:
```{r}
ei <- eigen(cor(data))

A <- ei$vectors
Y <- as.matrix(scale(data)) %*% A

cbind(Y[seq(10), seq(3)], pc$scores[seq(10),seq(3)])
```


```{r eval=FALSE, include=FALSE}
biplot(pc, cex=0.5)
```

```{r}
plot(pc$scores, type="n")
text(pc$scores, row.names(data), cex=0.6)
```
Заметим выброс в виде пациента №166: для него характерно большое значение Comp.1 -- повышенные "медицинские" факторы -- при достаточно низком Comp.2
